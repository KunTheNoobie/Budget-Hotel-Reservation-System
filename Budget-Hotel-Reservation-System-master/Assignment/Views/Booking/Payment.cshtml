@* 
    Payment View
    Displays the payment form for completing a booking.
    Supports multiple payment methods: Credit Card, PayPal, and Bank Transfer.
    Shows booking summary, price breakdown, and payment form with validation.
*@
@model Assignment.ViewModels.Booking.PaymentViewModel
@{
    ViewData["Title"] = "Payment";
    var booking = Model.Booking!;
    var nights = (booking.CheckOutDate - booking.CheckInDate).Days;
    var basePrice = booking.Room.RoomType.BasePrice * nights;
    
    // Check if this is a package booking (package price is usually higher than room price)
    // If TotalPrice is significantly different from calculated basePrice, it's likely a package
    var isPackageBooking = booking.TotalPrice != basePrice && 
                          (booking.Promotion == null || booking.TotalPrice > basePrice);
    
    var discount = isPackageBooking ? 0 : (basePrice - booking.TotalPrice);
    
    // Ensure discount is not negative (which would indicate package booking)
    if (discount < 0) discount = 0;
    
    // Get package information from ViewBag
    var package = ViewBag.Package as Assignment.Models.Package;
    var packageServices = ViewBag.PackageServices as List<Assignment.Models.PackageItem> ?? new List<Assignment.Models.PackageItem>();
}

<div class="container mt-4">
    <h2 class="mb-4">Payment</h2>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Booking #@booking.BookingId</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Room Information</h5>
                            <p><strong>Room:</strong> @booking.Room.RoomNumber (@booking.Room.RoomType.Name)</p>
                            <p><strong>Check-In:</strong> @booking.CheckInDate.ToString("dd/MM/yyyy")</p>
                            <p><strong>Check-Out:</strong> @booking.CheckOutDate.ToString("dd/MM/yyyy")</p>
                            <p><strong>Nights:</strong> @nights</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Price Breakdown</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    @if (isPackageBooking && package != null)
                                    {
                                        var roomPrice = booking.Room.RoomType.BasePrice * nights;
                                        var servicesTotal = packageServices.Sum(pi => pi.Service != null ? (pi.Service.Price * pi.Quantity) : 0);
                                        
                                        <tr>
                                            <td>Room (@nights night(s) × RM @booking.Room.RoomType.BasePrice.ToString("F2")):</td>
                                            <td class="text-end">RM @roomPrice.ToString("F2")</td>
                                        </tr>
                                        @if (packageServices.Any())
                                        {
                                            @foreach (var serviceItem in packageServices)
                                            {
                                                if (serviceItem.Service != null)
                                                {
                                                    var serviceTotal = serviceItem.Service.Price * serviceItem.Quantity;
                                                    <tr>
                                                        <td class="ps-3">
                                                            <small>• @serviceItem.Service.Name
                                                            @if (serviceItem.Quantity > 1)
                                                            {
                                                                <text> (x@(serviceItem.Quantity))</text>
                                                            }
                                                            </small>
                                                        </td>
                                                        <td class="text-end"><small>RM @serviceTotal.ToString("F2")</small></td>
                                                    </tr>
                                                }
                                            }
                                            <tr>
                                                <td><strong>Services Total:</strong></td>
                                                <td class="text-end"><strong>RM @servicesTotal.ToString("F2")</strong></td>
                                            </tr>
                                        }
                                        <tr class="table-active">
                                            <td><strong>Package Total:</strong></td>
                                            <td class="text-end"><strong class="text-primary">RM @booking.TotalPrice.ToString("F2")</strong></td>
                                        </tr>
                                    }
                                    else
                                    {
                                        <tr>
                                            <td>Base Price (@nights nights × RM @booking.Room.RoomType.BasePrice.ToString("F2")):</td>
                                            <td class="text-end">RM @basePrice.ToString("F2")</td>
                                        </tr>
                                        @if (booking.Promotion != null && discount > 0)
                                        {
                                            <tr>
                                                <td>Promotion (@booking.Promotion.Code):</td>
                                                <td class="text-end text-danger">-RM @discount.ToString("F2")</td>
                                            </tr>
                                        }
                                        <tr class="table-active">
                                            <td><strong>Total Amount:</strong></td>
                                            <td class="text-end"><strong class="price-display">RM @booking.TotalPrice.ToString("F2")</strong></td>
                                        </tr>
                                    }
                                </table>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <form asp-action="ProcessPayment" method="post">
                        <input type="hidden" asp-for="BookingId" />
                        @if (!ViewData.ModelState.IsValid)
                        {
                        <div asp-validation-summary="All" class="alert alert-danger"></div>
                        }

                        <h5 class="mb-3">Payment Method</h5>
                        <div class="mb-3">
                            <select asp-for="PaymentMethod" id="paymentMethod" class="form-select" required>
                                <option value="">-- Select Payment Method --</option>
                                <option value="0">Credit/Debit Card</option>
                                <option value="1">PayPal</option>
                                <option value="2">Bank Transfer</option>
                            </select>
                            <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                        </div>

                        <!-- Credit Card Fields -->
                        <div id="creditCardFields" style="display: none;">
                            <h6 class="mt-4 mb-3">Card Information</h6>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label asp-for="CardNumber" class="form-label"></label>
                                    <input asp-for="CardNumber" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19" />
                                    <span asp-validation-for="CardNumber" class="text-danger"></span>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label asp-for="CardholderName" class="form-label"></label>
                                    <input asp-for="CardholderName" class="form-control" placeholder="Name on card" />
                                    <span asp-validation-for="CardholderName" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="ExpiryMonth" class="form-label">Expiry Month</label>
                                    <select asp-for="ExpiryMonth" class="form-select">
                                        <option value="">Month</option>
                                        @for (int i = 1; i <= 12; i++)
                                        {
                                            <option value="@i">@i.ToString("00")</option>
                                        }
                                    </select>
                                    <span asp-validation-for="ExpiryMonth" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="ExpiryYear" class="form-label">Expiry Year</label>
                                    <select asp-for="ExpiryYear" class="form-select">
                                        <option value="">Year</option>
                                        @for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 10; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                    <span asp-validation-for="ExpiryYear" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="CVV" class="form-label"></label>
                                    <input asp-for="CVV" class="form-control" placeholder="123" maxlength="4" />
                                    <span asp-validation-for="CVV" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- PayPal Fields -->
                        <div id="paypalFields" style="display: none;">
                            <h6 class="mt-4 mb-3">PayPal Account</h6>
                            <div class="mb-3">
                                <label asp-for="PayPalEmail" class="form-label"></label>
                                <input asp-for="PayPalEmail" type="email" class="form-control" placeholder="your.email@example.com" />
                                <span asp-validation-for="PayPalEmail" class="text-danger"></span>
                                <small class="form-text text-muted">You will be redirected to PayPal to complete the payment.</small>
                            </div>
                        </div>

                        <!-- Bank Transfer Fields -->
                        <div id="bankTransferFields" style="display: none;">
                            <h6 class="mt-4 mb-3">Bank Transfer Details</h6>
                            <div class="mb-3">
                                <label asp-for="BankName" class="form-label"></label>
                                <select asp-for="BankName" class="form-select">
                                    <option value="">-- Select Bank --</option>
                                    <option value="Maybank">Maybank</option>
                                    <option value="CIMB Bank">CIMB Bank</option>
                                    <option value="Public Bank">Public Bank</option>
                                    <option value="RHB Bank">RHB Bank</option>
                                    <option value="Hong Leong Bank">Hong Leong Bank</option>
                                    <option value="AmBank">AmBank</option>
                                    <option value="UOB">UOB</option>
                                    <option value="OCBC Bank">OCBC Bank</option>
                                    <option value="Standard Chartered">Standard Chartered</option>
                                    <option value="HSBC Bank">HSBC Bank</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="BankName" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="AccountNumber" class="form-label"></label>
                                <input asp-for="AccountNumber" class="form-control" placeholder="Enter account number" />
                                <span asp-validation-for="AccountNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="AccountHolderName" class="form-label"></label>
                                <input asp-for="AccountHolderName" class="form-control" placeholder="Account holder name" />
                                <span asp-validation-for="AccountHolderName" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="ReferenceNumber" class="form-label">Transaction Reference Number (Optional)</label>
                                <input asp-for="ReferenceNumber" class="form-control" placeholder="Enter reference number if available" />
                                <span asp-validation-for="ReferenceNumber" class="text-danger"></span>
                            </div>
                            <div class="alert alert-info">
                                <strong>Bank Transfer Instructions:</strong><br />
                                Please transfer RM @booking.TotalPrice.ToString("F2") to:<br />
                                <strong>Account:</strong> BudgetHotel Sdn Bhd<br />
                                <strong>Account Number:</strong> 1234567890<br />
                                <strong>Bank:</strong> Maybank<br />
                                <strong>Reference:</strong> Booking #@booking.BookingId
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-lock-fill me-2"></i>Complete Payment
                            </button>
                            <a asp-action="MyBookings" class="btn btn-secondary w-100 mt-2">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Payment Summary</h5>
                </div>
                <div class="card-body">
                    <p><strong>Booking ID:</strong> #@booking.BookingId</p>
                    <p><strong>Room:</strong> @booking.Room.RoomNumber</p>
                    <p><strong>Check-In:</strong> @booking.CheckInDate.ToString("dd/MM/yyyy")</p>
                    <p><strong>Check-Out:</strong> @booking.CheckOutDate.ToString("dd/MM/yyyy")</p>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <strong>Total Amount:</strong>
                        <strong class="price-display">RM @booking.TotalPrice.ToString("F2")</strong>
                    </div>
                    @if (isPackageBooking)
                    {
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-box-seam me-2"></i>Package Booking
                        </div>
                    }
                    else if (booking.Promotion != null && discount > 0)
                    {
                        <div class="alert alert-success mt-3 mb-0">
                            <i class="bi bi-tag-fill me-2"></i>Promotion Applied: @booking.Promotion.Code
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
                // Hide validation summary if no errors
                var validationSummary = $('.alert-danger');
                if (validationSummary.length > 0 && validationSummary.text().trim() === '') {
                    validationSummary.hide();
                }
                
                // Ensure all fields are hidden by default
                $('#creditCardFields').hide();
                $('#paypalFields').hide();
                $('#bankTransferFields').hide();
                
                // Remove required attributes by default
                $('input[name="CardNumber"], input[name="CardholderName"], select[name="ExpiryMonth"], select[name="ExpiryYear"], input[name="CVV"]').prop('required', false);
                $('input[name="PayPalEmail"]').prop('required', false);
                $('select[name="BankName"], input[name="AccountNumber"], input[name="AccountHolderName"]').prop('required', false);
                
            $('#paymentMethod').on('change', function() {
                var method = $(this).val();
                
                // Hide all fields
                $('#creditCardFields').hide();
                $('#paypalFields').hide();
                $('#bankTransferFields').hide();
                
                    // Remove all required attributes first
                    $('input[name="CardNumber"], input[name="CardholderName"], select[name="ExpiryMonth"], select[name="ExpiryYear"], input[name="CVV"]').prop('required', false);
                    $('input[name="PayPalEmail"]').prop('required', false);
                    $('select[name="BankName"], input[name="AccountNumber"], input[name="AccountHolderName"]').prop('required', false);
                    
                    // Show relevant fields based on selected method
                    if (method === '0' || method === 'CreditCard') {
                        $('#creditCardFields').show();
                        $('input[name="CardNumber"], input[name="CardholderName"], select[name="ExpiryMonth"], select[name="ExpiryYear"], input[name="CVV"]').prop('required', true);
                }
                
                    if (method === '1' || method === 'PayPal') {
                    $('#paypalFields').show();
                    $('input[name="PayPalEmail"]').prop('required', true);
                }
                
                    if (method === '2' || method === 'BankTransfer') {
                    $('#bankTransferFields').show();
                    $('select[name="BankName"], input[name="AccountNumber"], input[name="AccountHolderName"]').prop('required', true);
                }
            });
            
            // Format card number
            $('input[name="CardNumber"]').on('input', function() {
                var value = $(this).val().replace(/\s/g, '');
                var formatted = value.match(/.{1,4}/g)?.join(' ') || value;
                $(this).val(formatted);
            });
        });
    </script>
}
